<template>
  <GridLayout
    class="vertical-swiper-container"
    :height="containerHeight"
  >
    <!-- ÂΩìÂâçËßÜÈ¢ë -->
    <StackLayout
      row="0"
      class="video-page"
      :visibility="currentIndex >= 0 ? 'visible' : 'collapsed'"
    >
      <ShortVideoItem
        v-if="currentVideo"
        :video="currentVideo"
        :index="currentIndex"
        :container-width="containerWidth"
        :container-height="containerHeight"
        :progress="progress[currentIndex] || 0"
        :is-playing="isCurrentVideoPlaying"
        @play="onVideoPlay"
        @pause="onVideoPause"
        @progress-change="onProgressChange"
      />
    </StackLayout>

    <!-- ‰∏ã‰∏Ä‰∏™ËßÜÈ¢ë (È¢ÑÂä†ËΩΩ) -->
    <StackLayout
      row="0"
      class="video-page next-video"
      :visibility="nextVideo ? 'visible' : 'collapsed'"
      :translate-y="containerHeight"
    >
      <ShortVideoItem
        v-if="nextVideo"
        :video="nextVideo"
        :index="currentIndex + 1"
        :container-width="containerWidth"
        :container-height="containerHeight"
        :progress="progress[currentIndex + 1] || 0"
        :is-playing="false"
        @play="onVideoPlay"
        @pause="onVideoPause"
        @progress-change="onProgressChange"
      />
    </StackLayout>

    <!-- ‰∏ä‰∏Ä‰∏™ËßÜÈ¢ë (È¢ÑÂä†ËΩΩ) -->
    <StackLayout
      row="0"
      class="video-page prev-video"
      :visibility="prevVideo ? 'visible' : 'collapsed'"
      :translate-y="-containerHeight"
    >
      <ShortVideoItem
        v-if="prevVideo"
        :video="prevVideo"
        :index="currentIndex - 1"
        :container-width="containerWidth"
        :container-height="containerHeight"
        :progress="progress[currentIndex - 1] || 0"
        :is-playing="false"
        @play="onVideoPlay"
        @pause="onVideoPause"
        @progress-change="onProgressChange"
      />
    </StackLayout>

    <!-- ÊâãÂäøÊ£ÄÊµãÂ±Ç -->
    <StackLayout
      row="0"
      class="gesture-layer"
      @pan="onPan"
      @touch="onTouch"
    />

    <!-- ‰æßËæπÊ†è (ÁÇπËµû„ÄÅÂàÜ‰∫´Á≠â) -->
    <StackLayout
      v-if="currentVideo"
      row="0"
      class="side-actions"
      horizontal-alignment="right"
      vertical-alignment="bottom"
    >
      <StackLayout
        class="action-item"
        @tap="onLike"
      >
        <Label
          :text="isLiked ? '‚ù§Ô∏è' : 'ü§ç'"
          class="action-icon"
        />
        <Label
          :text="formatCount(currentVideo.likeCount || 0)"
          class="action-count"
        />
      </StackLayout>

      <StackLayout
        class="action-item"
        @tap="onComment"
      >
        <Label
          text="üí¨"
          class="action-icon"
        />
        <Label
          :text="formatCount(currentVideo.commentCount || 0)"
          class="action-count"
        />
      </StackLayout>

      <StackLayout
        class="action-item"
        @tap="onShare"
      >
        <Label
          text="üì§"
          class="action-icon"
        />
        <Label
          text="ÂàÜ‰∫´"
          class="action-text"
        />
      </StackLayout>
    </StackLayout>
  </GridLayout>
</template>

<script setup lang="ts">
import { ref, computed, watch, onMounted, onUnmounted } from 'vue';
// defineProps and defineEmits are compiler macros, no import needed
import {
  GestureEventData,
  PanGestureEventData,
  TouchGestureEventData,
  Animation,
  View,
  AnimationDefinition
} from '@nativescript/core';
import { VideoItem } from '@/types/video';
import { UserAnalytics } from '@/services/analytics.service';
import { VideoPlayerService } from '@/services/video-player.service';
import { VideoMemoryManager } from '@/services/video-memory.service';
import ShortVideoItem from './ShortVideoItem.vue';

// Props
interface Props {
  videoList: VideoItem[];
  containerWidth: number;
  containerHeight: number;
  progress: number[];
  initialIndex?: number;
}

const props = defineProps<Props>();

// Emits
const emit = defineEmits<{
  'update:progress': [progress: number[]];
  'update:currentIndex': [index: number];
  'videoChange': [index: number];
}>();

// State
const currentIndex = ref(props.initialIndex || 0);
const isCurrentVideoPlaying = ref(false);
const isLiked = ref(false);
const progress = ref([...props.progress]);
const isTransitioning = ref(false);
const panStartY = ref(0);
const currentTranslateY = ref(0);

// Computed
const currentVideo = computed(() => {
  return props.videoList[currentIndex.value] || null;
});

const nextVideo = computed(() => {
  return props.videoList[currentIndex.value + 1] || null;
});

const prevVideo = computed(() => {
  return props.videoList[currentIndex.value - 1] || null;
});

// Methods
const formatCount = (count: number): string => {
  if (count >= 1000000) {
    return `${(count / 1000000).toFixed(1)}M`;
  } else if (count >= 1000) {
    return `${(count / 1000).toFixed(1)}K`;
  }
  return count.toString();
};

const onVideoPlay = (index: number) => {
  if (index === currentIndex.value) {
    isCurrentVideoPlaying.value = true;
  }

  UserAnalytics.trackEvent('vertical_swiper_video_play', {
    videoIndex: index,
    videoId: props.videoList[index]?.id
  });
};

const onVideoPause = (index: number) => {
  if (index === currentIndex.value) {
    isCurrentVideoPlaying.value = false;
  }
};

const onProgressChange = (index: number, newProgress: number) => {
  progress.value[index] = newProgress;
  emit('update:progress', [...progress.value]);
};

// ÊâãÂäøÂ§ÑÁêÜ
const onPan = (args: PanGestureEventData) => {
  if (isTransitioning.value) return;

  const deltaY = args.deltaY;
  const startTime = Date.now();

  switch (args.state) {
    case 1: // began
      panStartY.value = deltaY;
      // ÊöÇÂÅúÂΩìÂâçËßÜÈ¢ë‰ª•ÊèêÂçáÊªëÂä®ÊÄßËÉΩ
      VideoPlayerService.pauseVideoById(currentVideo.value?.id || '');
      isCurrentVideoPlaying.value = false;
      break;

    case 2: // changed
      currentTranslateY.value = deltaY;
      // ÈôêÂà∂ÊªëÂä®ËåÉÂõ¥‰ª•Êèê‰æõÈòªÂ∞ºÊïàÊûú
      const maxDelta = props.containerHeight * 0.6;
      const clampedDelta = Math.max(-maxDelta, Math.min(maxDelta, deltaY));

      // ÂÆûÊó∂Êõ¥Êñ∞ËßÜÈ¢ë‰ΩçÁΩÆÔºàËøôÈáåÈúÄË¶ÅÂÆûÈôÖÁöÑ View ÂºïÁî®Ôºâ
      // TODO: ÂÆûÁé∞ÂÆûÈôÖÁöÑËßÜÂõæ‰ΩçÁΩÆÊõ¥Êñ∞
      break;

    case 3: // ended
      const endTime = Date.now();
      const latency = endTime - startTime;
      VideoMemoryManager.recordSwipeLatency(latency);

      handlePanEnd(deltaY);
      break;
  }
};

const handlePanEnd = (deltaY: number) => {
  const threshold = props.containerHeight * 0.25; // 25% ÁöÑÈòàÂÄº
  const velocity = Math.abs(deltaY); // ÁÆÄÂåñÁöÑÈÄüÂ∫¶ËÆ°ÁÆó

  if (Math.abs(deltaY) > threshold || velocity > 200) {
    if (deltaY > 0 && currentIndex.value > 0) {
      // Âêë‰∏ãÊªëÂä® - ‰∏ä‰∏Ä‰∏™ËßÜÈ¢ë
      switchToPrevious();
    } else if (deltaY < 0 && currentIndex.value < props.videoList.length - 1) {
      // Âêë‰∏äÊªëÂä® - ‰∏ã‰∏Ä‰∏™ËßÜÈ¢ë
      switchToNext();
    } else {
      // Â∑≤Âà∞ËæπÁïåÔºåÂõûÂºπ
      animateToPosition(0);
    }
  } else {
    // ÊªëÂä®Ë∑ùÁ¶ª‰∏çË∂≥ÔºåÂõûÂºπ
    animateToPosition(0);
  }
};

const switchToNext = () => {
  if (currentIndex.value >= props.videoList.length - 1) return;

  isTransitioning.value = true;

  // ËÆ∞ÂΩïÂàáÊç¢ÂºÄÂßãÊó∂Èó¥
  const switchStartTime = Date.now();

  // È¢ÑÂä†ËΩΩ‰∏ã‰∏ã‰∏™ËßÜÈ¢ë
  const nextNextVideo = props.videoList[currentIndex.value + 2];
  if (nextNextVideo) {
    VideoPlayerService.preloadVideo(nextNextVideo.id, nextNextVideo.videoUrl);
  }

  // Âä®ÁîªÂàáÊç¢Âà∞‰∏ã‰∏Ä‰∏™ËßÜÈ¢ë
  animateToPosition(-props.containerHeight, () => {
    currentIndex.value++;
    resetPositions();
    emit('update:currentIndex', currentIndex.value);
    emit('videoChange', currentIndex.value);

    // ËÆ∞ÂΩïÂàáÊç¢ÂÆåÊàêÊó∂Èó¥
    const switchEndTime = Date.now();
    VideoMemoryManager.recordSwipeLatency(switchEndTime - switchStartTime);

    UserAnalytics.trackEvent('vertical_swiper_next', {
      currentIndex: currentIndex.value,
      videoId: currentVideo.value?.id,
      switchTime: switchEndTime - switchStartTime
    });
  });
};

const switchToPrevious = () => {
  if (currentIndex.value <= 0) return;

  isTransitioning.value = true;
  const switchStartTime = Date.now();

  // Âä®ÁîªÂàáÊç¢Âà∞‰∏ä‰∏Ä‰∏™ËßÜÈ¢ë
  animateToPosition(props.containerHeight, () => {
    currentIndex.value--;
    resetPositions();
    emit('update:currentIndex', currentIndex.value);
    emit('videoChange', currentIndex.value);

    const switchEndTime = Date.now();
    VideoMemoryManager.recordSwipeLatency(switchEndTime - switchStartTime);

    UserAnalytics.trackEvent('vertical_swiper_previous', {
      currentIndex: currentIndex.value,
      videoId: currentVideo.value?.id,
      switchTime: switchEndTime - switchStartTime
    });
  });
};

const animateToPosition = (targetY: number, callback?: () => void) => {
  // ‰ΩøÁî®Êõ¥ÊµÅÁïÖÁöÑÂä®ÁîªÈÖçÁΩÆ
  const animationDefinition: AnimationDefinition = {
    translate: { x: 0, y: targetY },
    duration: 300,
    curve: 'easeInOut'
  };

  // ËøôÈáåÈúÄË¶ÅÂÆûÈôÖÁöÑ View ÂºïÁî®Êù•ÊâßË°åÂä®Áîª
  // Âú®ÂÆûÈôÖÂÆûÁé∞‰∏≠ÔºåÈúÄË¶ÅËé∑ÂèñÂà∞ËßÜÈ¢ëÈ°µÈù¢ÁöÑ View ÂØπË±°
  setTimeout(() => {
    currentTranslateY.value = targetY;
    if (callback) callback();
    isTransitioning.value = false;
  }, 300);
};

const resetPositions = () => {
  currentTranslateY.value = 0;
  // ÈáçÁΩÆÊâÄÊúâËßÜÈ¢ëÈ°µÈù¢ÁöÑ‰ΩçÁΩÆ
  // TODO: ÂÆûÁé∞ÂÆûÈôÖÁöÑ‰ΩçÁΩÆÈáçÁΩÆÈÄªËæë
};

const onTouch = (args: TouchGestureEventData) => {
  // Â§ÑÁêÜÁÇπÂáª‰∫ã‰ª∂ - Êí≠Êîæ/ÊöÇÂÅú
  if (args.action === 'up' && !isTransitioning.value) {
    isCurrentVideoPlaying.value = !isCurrentVideoPlaying.value;
  }
};

// ‰æßËæπÊ†èÂä®‰Ωú
const onLike = () => {
  isLiked.value = !isLiked.value;
  UserAnalytics.trackEvent('video_like', {
    videoId: currentVideo.value?.id,
    isLiked: isLiked.value
  });
};

const onComment = () => {
  UserAnalytics.trackEvent('video_comment_tap', {
    videoId: currentVideo.value?.id
  });
  // TODO: ÊâìÂºÄËØÑËÆ∫ÂºπÁ™ó
};

const onShare = () => {
  UserAnalytics.trackEvent('video_share_tap', {
    videoId: currentVideo.value?.id
  });
  // TODO: ÊâìÂºÄÂàÜ‰∫´ÂºπÁ™ó
};

// Watch
watch(() => props.progress, (newProgress) => {
  progress.value = [...newProgress];
}, { deep: true });

watch(currentIndex, (newIndex) => {
  // ÂΩìÁ¥¢ÂºïÊîπÂèòÊó∂ÔºåËá™Âä®Êí≠ÊîæÂΩìÂâçËßÜÈ¢ë
  setTimeout(() => {
    isCurrentVideoPlaying.value = true;
  }, 300);
});

// Lifecycle
onMounted(() => {
  // ÂàùÂßãÂåñÊó∂Ëá™Âä®Êí≠ÊîæÁ¨¨‰∏Ä‰∏™ËßÜÈ¢ë
  if (props.videoList.length > 0) {
    // È¢ÑÂä†ËΩΩÂâçÂá†‰∏™ËßÜÈ¢ë
    props.videoList.slice(0, 3).forEach((video, index) => {
      VideoPlayerService.preloadVideo(video.id, video.videoUrl);
    });

    // Âª∂ËøüÂêØÂä®Á¨¨‰∏Ä‰∏™ËßÜÈ¢ë
    setTimeout(() => {
      isCurrentVideoPlaying.value = true;
      if (currentVideo.value) {
        VideoPlayerService.playVideoById(currentVideo.value.id);
      }
    }, 500);
  }

  // ÂêØÂä®ÊÄßËÉΩÁõëÊéß
  VideoMemoryManager.startMemoryMonitoring();
});

onUnmounted(() => {
  // Ê∏ÖÁêÜÊâÄÊúâÊí≠ÊîæÂô®
  VideoPlayerService.clearAllPlayers();

  // ÂÅúÊ≠¢ÊÄßËÉΩÁõëÊéß
  VideoMemoryManager.stopMemoryMonitoring();
});
</script>

<style scoped>
.vertical-swiper-container {
  background-color: #000;
  overflow: hidden;
}

.video-page {
  width: 100%;
  height: 100%;
  background-color: #000;
}

.gesture-layer {
  width: 100%;
  height: 100%;
  background-color: transparent;
  z-index: 1;
}

.side-actions {
  width: 80;
  margin-right: 15;
  margin-bottom: 100;
  z-index: 10;
}

.action-item {
  width: 60;
  height: 70;
  text-align: center;
  margin-bottom: 20;
}

.action-icon {
  font-size: 28;
  text-align: center;
  margin-bottom: 5;
}

.action-count, .action-text {
  font-size: 12;
  color: white;
  text-align: center;
  text-shadow: 1 1 2 rgba(0, 0, 0, 0.8);
}

.next-video, .prev-video {
  z-index: -1;
}
</style>